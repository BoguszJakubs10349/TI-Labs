<!doctype html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <title>Lab06 — Notes</title>
    <style>
        body {
            font-family: Arial;
            margin: 20px
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            min-width: 360px
        }

        input, textarea, button {
            width: 100%;
            padding: 8px;
            margin: 6px 0;
            box-sizing: border-box
        }

        textarea {
            min-height: 90px
        }

        .ok {
            color: green
        }

        .err {
            color: #b00020
        }

        .note {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0
        }

        .small {
            font-size: 12px;
            opacity: .75
        }
    </style>
</head>
<body>
    <h1>Lab06 — Notatki, tagi i wyszukiwanie</h1>
    <p id="msg"></p>

    <div class="row">
        <div class="card">
            <h3>Szukaj</h3>
            <input id="q" placeholder="Szukaj w tytule lub treści..." oninput="load()" />
            <input id="tag" placeholder="(bonus) filtr tag, np. work" oninput="load()" />
            <button onclick="load()">Odśwież</button>
        </div>

        <div class="card">
            <h3>Dodaj notatkę</h3>
            <input id="t" placeholder="Tytuł" />
            <textarea id="b" placeholder="Treść"></textarea>
            <input id="tags" placeholder='Tagi po przecinku, np. work,home' />
            <button onclick="addNote()">Dodaj</button>
            <button onclick="loadTags()">Pokaż wszystkie tagi</button>
            <div id="alltags" class="small"></div>
        </div>
    </div>

    <h2>Wyniki</h2>
    <div id="list"></div>

    <script>const msg=(t,ok=true)=>{const el=document.getElementById('msg');el.className=ok?'ok':'err';el.textContent=t;}
async function api(url,method='GET',body=null){
  const res=await fetch(url,{method,headers:body?{'Content-Type':'application/json'}:{},body:body?JSON.stringify(body):null});
  const text=await res.text(); let data=null; try{data=text?JSON.parse(text):null}catch{}
  if(!res.ok) throw new Error(data?.error||data?.title||text||('HTTP '+res.status));
  return data;
}

async function load(){
  try{
    const q = document.getElementById('q').value.trim();
    const tag = document.getElementById('tag').value.trim();
    const params = new URLSearchParams();
    if(q) params.set('q', q);
    if(tag) params.set('tag', tag);
    const list = await api('/api/notes' + (params.toString()?('?'+params.toString()):''));

    document.getElementById('list').innerHTML = list.length ? list.map(n=>`
      <div class="note">
        <div><b>${n.title}</b> <span class="small">(#${n.id} • ${n.createdAt})</span></div>
        <div>${n.snippet}</div>
      </div>
    `).join('') : '<p>Brak wyników.</p>';
  }catch(e){msg(e.message,false);}
}

async function addNote(){
  try{
    const title = document.getElementById('t').value;
    const body = document.getElementById('b').value;
    const res = await api('/api/notes','POST',{title,body});
    const id = res.id;

    const tagsRaw = document.getElementById('tags').value;
    const tags = tagsRaw.split(',').map(x=>x.trim()).filter(x=>x.length);

    if(tags.length){
      await api(`/api/notes/${id}/tags`,'POST',{tags});
    }

    msg('Dodano notatkę');
    document.getElementById('t').value='';
    document.getElementById('b').value='';
    document.getElementById('tags').value='';
    await load();
    await loadTags();
  }catch(e){msg(e.message,false);}
}

async function loadTags(){
  try{
    const tags = await api('/api/tags');
    document.getElementById('alltags').textContent = tags.map(t=>t.name).join(', ');
  }catch(e){msg(e.message,false);}
}

load();
loadTags();</script>
</body>
</html>
